module kanidm_policy 1.0;

require {
    type unconfined_service_t;
    type sshd_t;
    type init_t;
    type var_run_t;
    type systemd_userdbd_t;
    type auditd_t;
    type setroubleshootd_t;
    type systemd_logind_t;
    type chkpwd_t;
    type local_login_t;
    type pcp_pmie_t;
    type pcp_pmlogger_t;
    type xdm_t;
    type policykit_t;
    type policykit_auth_t;
    type colord_t;
    type NetworkManager_t;
    type accountsd_t;
    type systemd_tmpfiles_t;
    type cupsd_t;
    class unix_stream_socket { read write connect connectto };
    class sock_file { write getattr };
}

# Allow sshd to access the socket file and connect to the service
allow sshd_t var_run_t:sock_file { write getattr };
allow sshd_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow init_t (systemd processes) to connect to the socket
allow init_t unconfined_service_t:unix_stream_socket { read write connect connectto };
allow init_t var_run_t:sock_file write;

# Allow systemd-userdbd to access the socket
allow systemd_userdbd_t var_run_t:sock_file write;
allow systemd_userdbd_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow auditd to access the socket
allow auditd_t var_run_t:sock_file write;
allow auditd_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow setroubleshootd to access the socket
allow setroubleshootd_t var_run_t:sock_file write;
allow setroubleshootd_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow systemd-logind to access the socket
allow systemd_logind_t var_run_t:sock_file write;
allow systemd_logind_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow chkpwd to access the socket
allow chkpwd_t var_run_t:sock_file write;
allow chkpwd_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow local_login to access the socket
allow local_login_t var_run_t:sock_file write;
allow local_login_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow Performance Co-Pilot services to access the socket
allow pcp_pmie_t var_run_t:sock_file write;
allow pcp_pmie_t unconfined_service_t:unix_stream_socket { read write connect connectto };

allow pcp_pmlogger_t var_run_t:sock_file write;
allow pcp_pmlogger_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow X display manager to access the socket
allow xdm_t var_run_t:sock_file write;
allow xdm_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow PolicyKit services to access the socket
allow policykit_t var_run_t:sock_file write;
allow policykit_t unconfined_service_t:unix_stream_socket { read write connect connectto };

allow policykit_auth_t var_run_t:sock_file write;
allow policykit_auth_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow color management daemon to access the socket
allow colord_t var_run_t:sock_file write;
allow colord_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow NetworkManager to access the socket
allow NetworkManager_t var_run_t:sock_file write;
allow NetworkManager_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow accounts daemon to access the socket
allow accountsd_t var_run_t:sock_file write;
allow accountsd_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow systemd-tmpfiles to access the socket
allow systemd_tmpfiles_t var_run_t:sock_file write;
allow systemd_tmpfiles_t unconfined_service_t:unix_stream_socket { read write connect connectto };

# Allow CUPS printing daemon to access the socket
allow cupsd_t var_run_t:sock_file write;
allow cupsd_t unconfined_service_t:unix_stream_socket { read write connect connectto };